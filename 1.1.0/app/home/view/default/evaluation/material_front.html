{include file="public/header/nav_membership_header"}
<!--引入CSS-->
<link rel="stylesheet" type="text/css" href="__PUBLIC__/images/webuploader.css">

<!--引入JS-->
<script type="text/javascript" src="__PUBLIC__/images/webuploader.js"></script>


<div class="main w1000" style="background:#fff;">
    <div class="fb-source source_none" >
        <ul>
            <li>
                <a href="{:url('/')}">首页</a>
                <span >-></span>
            </li>
            <li>
                <a>经济困难认定</a>
                <span >-></span>
            </li>
            <li>
                <a>佐证材料</a>
                <span >-></span>
            </li>
        </ul>
    </div>
    <form class="personal_table upload_form" action="{:url('show/material_post')}" method="post" enctype="multipart/form-data" id="material_form">
        <table width="756px">
            <tbody>
            <tr style="height:30px;">
                <td colspan="2"></td>
                <td colspan="1" style="text-align: right;">
                    <span style="font-size: 13px;color: grey;">广东农工商职业技术学院</span>
                </td>
            </tr>
            <tr>
                <td colspan="3" style="text-align: center;font-size: 25px;font-weight: bold;border-top:1px solid #000000;line-height:48px;">
                    广东省家庭经济困难学生认定分析表
                </td>
            </tr>
            </tbody>
        </table>

        <br>
		{if $eval_app}
		{if $material}
		<table class="table_one" style="word-wrap: break-word;word-break: break-all;">
            <tbody>
                <tr class="table-tr">
                    <td>序号</td>
                    <td style="width:100px;">困难情况</td>
                    <td>证明材料</td>
                    <td>文件</td>
                </tr>
                <tr class="table-tr">
                    <td>1</td>
                    <td>免冠证照</td>
                    <td>本人近期蓝底或红底免冠证件照</td>
                    <td class="title td_upfile">
                       <a href="{$user.member_list_headpic}" target="_blank"><img src="{$user.member_list_headpic}" width="100px;"/></a>
                    </td>
                </tr>
                {foreach name="material" item="v"}
                <tr class="table-tr">
                    <td>{++$m}</td>
                    <td>{$v.name}</td>
                    <td>{$v.desc}</td>
                    <td class="title td_upfile">
                        <a href="{$v.images}" target="_blank"><img src="{$v.images}" width="100px;"/></a>
                    </td>
                </tr>
                {/foreach}
            </tbody>
        </table>
		{else}

        <table class="table_one material_table" style="word-wrap: break-word;word-break: break-all;">
            <tbody>
            <tr class="table-tr">
                <td>序号</td>
                <td style="width:100px;">困难情况</td>
                <td>证明材料</td>
                <td>说明</td>
                <td>操作</td>
                <td>状态</td>
            </tr>
            <tr class="table-tr">
                <td>1</td>
                <td>免冠证照</td>
                <td>本人近期蓝底或红底免冠证件照</td>
                <td>必须上传</td>
                <td class="title td_upfile">
                    <label class="file_ui">上传文件<input type="file"   name="member_list_headpic" id="member_list_headpic" class="upfile" ></label>
                    <!--<div class="upfile_name">文件名</div>-->
					<input type="hidden" name="member_list_headpic_url" id="member_list_headpic_url" value="{$user.member_list_headpic}" is_must="1" title="免冠证照"/>
                </td>
                <td >
					{if $user.member_list_headpic}
					<img src="{$user.member_list_headpic}" width="100px;"/>
					{else}
					<div class="upfile_name" id="member_list_headpic_image">文件名</div>
					{/if}
				</td>
            </tr>
            {foreach name="material_configs" item="v"}
            <tr class="table-tr">
                <td>{++$m}</td>
                <td>{$v.name}</td>
                <td>{$v.desc}</td>
                <td>{$v.remark}</td>
                <td class="title td_upfile">
                    <label class="file_ui">上传文件<input type="file"   name="image_{$v.cid}" id="image_{$v.cid}" class="upfile" ></label>
                    <!--<div class="upfile_name">文件名</div>-->
                    <input type="hidden" name="cids[]" id="cids" value="{$v.cid}"/>
					<input type="hidden" name="images[]" id="image_{$v.cid}_url" value="" is_must="{$v.is_must}"  title="{$v.name}"/>
                </td>
                <td ><div class="upfile_name" id="image_{$v.cid}_image">文件名</div></td>
            </tr>
            {/foreach}
            </tbody>
        </table>
		<button type="button" class="print printHide material_btn">提交</button>
		{/if}
		{else}
		<div style="text-align:center"><span style="color:#d80e0e;font-size:16px;">请先提交家庭经济困难学生认定申请</span></div>
		{/if}
    </form>
</div>
<script>
$(".upfile").change(function(){
	$(this).parent().parent().next().find(".upfile_name").text("");//将存放文件名的容器置空
	var filearr=$(this).get(0).files;//将文件DOM对象转化为JQ对象
	for(var i=0;i<filearr.length;i++) {
		var fileSize=filearr[i].size;//获取文件大小，单位为字节
		var extStart=filearr[i].name.lastIndexOf(".");//获取文件名中“.”后面的内容，后缀名
		var ext=filearr[i].name.substring(extStart,filearr[i].name.length).toUpperCase();
		if(fileSize/(1024*1024)>2) {
			layer.msg("文件大小超出限制，请重新选择！");
			$(this).attr("value","");
			$(this).val('');
			return false;
		}
		if(ext!=".PNG"&&ext!=".GIF"&&ext!=".JPG"&&ext!=".JPEG") {
			layer.msg("文件格式错误，请重新选择！");
			$(this).attr("value","");
			$(this).val('');
			return false;
		}
		if($(this).get(0)=='') return false;//检测是否为空，点击后没选择返回false
		var serial=i+1;
		$(this).parent().parent().next().find(".upfile_name").append(serial+"、"+"<u>"+filearr[i].name+"</u>"+"；")//输出文件名
	}
	load = layer.load(2);
	var formData = new FormData();
	var name = $(this).attr('name');
	formData.append("uploadfile", document.getElementById(name).files[0]);
	_this = $(this);
	$.ajax({
		url: "{:url('home/Show/material_upload')}",
		type: "POST",
		data: formData,
		contentType: false,
		processData: false,
		success: function (data) {
			layer.close(load);
			if(data.code == 200)
			{
				$("#"+name+'_url').val(data.url);
				$("#"+name+'_image').html('<img src="'+data.url+'" width="100px;"/>');
				layer.msg("上传成功！",{'icon':1});

			}
			else{
				_this.val('');
				layer.msg(data.message,{'icon':5});
			}

		},
		error: function () {
			_this.val('');
			layer.msg("上传失败！");
			layer.close(load);
		}
	});
});
$(".material_btn").click(function(){
	layer.confirm('上传后不能修改，确定上传？', {
		btn: ['确定','取消'] //按钮
	}, function(){
		bool = true;
		$('.material_table').find('input').each(function(){
			if($(this).attr('is_must'))
			{
				var value = $(this).val();
				if($fb.expEmpty(value) != true)
				{
					var title = $(this).attr('title') + '必须上传';
					layer.msg(title);
					bool = false;
					return false;
				}
			}
		});
		console.log('bool:' + bool);
		if(bool)
		{
			bool = null;
			$.ajax({
				type: 'post',
				url: "{:url('home/show/material_post')}",
				data: $("#material_form").serialize(),
				success: function(data) {
					if(data.code == 200)
					{
						window.location.href="{:url('home/show/material')}";
					}else{
						layer.msg(data.message);
					}
				}
			});
		}
	},function(){
		
	});
	return false;
})
</script>

{include file="public/footer"}
